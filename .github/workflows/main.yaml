on: [ push, pull_request ]
jobs:
  tests:
    strategy:
      matrix:
        include:
          - tox_env: py36
            base_image: python:3.6
          - tox_env: py37
            base_image: python:3.7
          - tox_env: py38
            base_image: python:3.8
          - tox_env: py39
            base_image: python:3.9
          - tox_env: flake8
            base_image: python:3.6
    runs-on: ubuntu-latest
    container: "${{ matrix.base_image }}"
    steps:
      - uses: actions/checkout@v2
      - run: pip install tox
      - run: tox -e "${{ matrix.tox_env }}"

  build-executable-linux:
    needs: tests
    runs-on: ubuntu-16.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.6'
      - name: Build executable
        run: |
          sudo apt-get install -y libusb-1.0
          pip install tox
          tox -e pyinstaller
      - uses: actions/upload-artifact@v2
        with:
          name: linux-build
          path: pyinstaller_build/dist/*
          if-no-files-found: error
          retention-days: 1

  test-executable-linux:
    runs-on: ubuntu-latest
    needs: build-executable-linux
    strategy:
      matrix:
        base_image: [ "ubuntu:18.04", "ubuntu:20.04" ]
    env:
      LC_ALL: "C.UTF-8"
      LANG: "C.UTF-8"
    container: "${{ matrix.base_image }}"
    steps:
      - uses: actions/checkout@v2
      - uses: actions/download-artifact@v2
        with:
          name: linux-build
          path: pyinstaller_build/dist
      - name: Install test dependencies
        run: |
          apt-get update
          apt-get install -y python3 python3-pytest
      - name: Run tests
        run: python3 test_build.py
        working-directory: pyinstaller_build

  build-executable-windows:
    needs: tests
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.6'
      - name: Build executable
        run: |
          pip install tox
          tox -e pyinstaller
      - uses: actions/upload-artifact@v2
        with:
          name: windows-build
          path: pyinstaller_build/dist/*
          if-no-files-found: error
          retention-days: 1

  test-executable-windows:
    needs: build-executable-windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.6'
      - uses: actions/download-artifact@v2
        with:
          name: windows-build
          path: pyinstaller_build/dist
      - name: Install test dependencies
        run: |
          pip install pytest
      - name: Run tests
        run: python test_build.py
        working-directory: pyinstaller_build
